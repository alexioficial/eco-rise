{% extends 'base.html' %}

{% block title %}Main{% endblock %}

{% block content %}

<style>
    .el_logo {
        width: 70%;
        margin-bottom: 15px;
        display: block;
        margin-left: auto;
        margin-right: auto;

        filter: drop-shadow(0 0 12px rgba(0, 123, 255, 0.7)) drop-shadow(0 0 24px rgba(0, 123, 255, 0.4));
        -webkit-filter: drop-shadow(0 0 12px rgba(0, 123, 255, 0.7)) drop-shadow(0 0 24px rgba(0, 123, 255, 0.4));
    }

    /* Map height in modal */
    #map-picker {
        height: 60vh;
    }
</style>

<!-- Leaflet CSS for this page only -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

<div class="row">
    <div class="col-12 col-md-10 col-lg-8 mx-auto">
        <img src="/static/imgs/logo.png" class="el_logo" alt="Logo">
        <div class="card shadow-sm">
            <div class="card-body">
                <h1 class="h4 mb-3">MAIN DATA</h1>

                <form id="form-principal" novalidate>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label for="ancho" class="form-label">WIDTH (m)</label>
                            <input type="number" step="0.01" min="0" class="form-control" id="ancho"
                                placeholder="Ex: 50" required>
                            <div class="invalid-feedback">Enter a valid width.</div>
                        </div>
                        <div class="col-6">
                            <label for="alto" class="form-label">LENGTH (m)</label>
                            <input type="number" step="0.01" min="0" class="form-control" id="alto" placeholder="Ex: 30"
                                required>
                            <div class="invalid-feedback">Enter a valid length.</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="tipoPlanta" class="form-label">Plant Type</label>
                        <select id="tipoPlanta" class="form-select" required>
                            <option value="" selected disabled>Select an option</option>
                            <option value="tomate">Tomato</option>
                            <option value="maiz">Corn</option>
                            <option value="lechuga">Lettuce</option>
                        </select>
                        <div class="invalid-feedback">Select a plant type.</div>
                    </div>

                    <div class="row g-2 align-items-end mb-2">
                        <div class="col-12">
                            <label class="form-label">Coordinates</label>
                        </div>
                        <div class="col-6">
                            <input type="text" inputmode="decimal" class="form-control" id="lat" placeholder="Latitude"
                                required>
                            <div class="invalid-feedback">Invalid latitude.</div>
                        </div>
                        <div class="col-6">
                            <input type="text" inputmode="decimal" class="form-control" id="lng" placeholder="Longitude"
                                required>
                            <div class="invalid-feedback">Invalid longitude.</div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6 mx-0 pe-1">
                            <button type="button" id="btn-geolocate" class="btn btn-outline-success">Use my
                                location</button>
                        </div>
                        <div class="col-6 mx-0 ps-1">
                            <button type="button" id="btn-pick-location" class="btn btn-outline-success">Use another
                                location</button>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Continue</button>
                    <div id="status" class="small text-muted mb-5"></div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal to select location on map -->
<div class="modal fade" id="modalMap" tabindex="-1" aria-labelledby="modalMapLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-sm-down modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalMapLabel">Select Location</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div id="map-picker"></div>
            </div>
            <div class="modal-footer d-flex w-100 justify-content-between">
                <div class="text-muted small" id="picked-preview">Click on the map to choose a point.</div>
                <div>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="btn-confirm-location">Use this location</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet JS for this page only -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
    (() => {
        const form = document.getElementById('form-principal');
        const statusEl = document.getElementById('status');
        const latEl = document.getElementById('lat');
        const lngEl = document.getElementById('lng');
        const pickBtn = document.getElementById('btn-pick-location');
        const confirmBtn = document.getElementById('btn-confirm-location');
        const previewEl = document.getElementById('picked-preview');
        const modalEl = document.getElementById('modalMap');
        let modalInstance = null;
        let map = null;
        let marker = null;
        let pickedLatLng = null;

        // Cookie helpers
        const setCookie = (name, value, days = 7) => {
            const d = new Date();
            d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = 'expires=' + d.toUTCString();
            document.cookie = `${name}=${encodeURIComponent(value)}; ${expires}; path=/; samesite=Lax`;
        };

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }
            const data = {
                ancho: document.getElementById('ancho').value,
                alto: document.getElementById('alto').value,
                tipoPlanta: document.getElementById('tipoPlanta').value,
                lat: latEl.value,
                lng: lngEl.value,
            };
            console.log('Main data', data);
            // Save to cookies to be read in Main
            setCookie('vi_ancho', data.ancho);
            setCookie('vi_alto', data.alto);
            setCookie('vi_tipoPlanta', data.tipoPlanta);
            setCookie('vi_lat', data.lat);
            setCookie('vi_lng', data.lng);
            window.location.href = '/Principal';
        });

        document.getElementById('btn-geolocate').addEventListener('click', () => {
            if (!('geolocation' in navigator)) {
                statusEl.textContent = 'Geolocation not supported on this device.';
                return;
            }
            statusEl.textContent = 'Getting locationâ€¦';
            navigator.geolocation.getCurrentPosition((pos) => {
                const { latitude, longitude } = pos.coords;
                latEl.value = latitude.toFixed(6);
                lngEl.value = longitude.toFixed(6);
                statusEl.textContent = 'Location obtained.';
            }, (err) => {
                statusEl.textContent = 'Could not get location: ' + err.message;
            }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
        });

        // Open modal and load map to manually choose location
        if (pickBtn) {
            pickBtn.addEventListener('click', () => {
                if (!modalInstance) {
                    modalInstance = new bootstrap.Modal(modalEl);
                }
                modalInstance.show();
                // Give time for modal to show before calculating map size
                setTimeout(() => {
                    if (!map) {
                        const startLat = parseFloat(latEl.value) || 18.7357; // Default RD, adjust to your region
                        const startLng = parseFloat(lngEl.value) || -70.1627;
                        map = L.map('map-picker').setView([startLat, startLng], 7);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            maxZoom: 19,
                            attribution: '&copy; OpenStreetMap'
                        }).addTo(map);
                        map.on('click', (e) => {
                            pickedLatLng = e.latlng;
                            if (!marker) {
                                marker = L.marker(e.latlng, { draggable: true }).addTo(map);
                                marker.on('dragend', () => {
                                    pickedLatLng = marker.getLatLng();
                                    previewEl.textContent = `Lat: ${pickedLatLng.lat.toFixed(6)}, Lng: ${pickedLatLng.lng.toFixed(6)}`;
                                });
                            } else {
                                marker.setLatLng(e.latlng);
                            }
                            previewEl.textContent = `Lat: ${pickedLatLng.lat.toFixed(6)}, Lng: ${pickedLatLng.lng.toFixed(6)}`;
                        });
                    } else {
                        map.invalidateSize();
                    }
                }, 150);
            });
        }

        if (confirmBtn) {
            confirmBtn.addEventListener('click', () => {
                if (pickedLatLng) {
                    latEl.value = pickedLatLng.lat.toFixed(6);
                    lngEl.value = pickedLatLng.lng.toFixed(6);
                }
                if (!modalInstance) {
                    modalInstance = new bootstrap.Modal(modalEl);
                }
                modalInstance.hide();
            });
        }
    })();
</script>
{% endblock %}