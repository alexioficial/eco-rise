{% extends 'base.html' %}

{% block title %}Principal{% endblock %}

{% block content %}

<style>
    .el_logo {
        width: 70%;
        margin-bottom: 15px;
        display: block;
        margin-left: auto;
        margin-right: auto;

        filter: drop-shadow(0 0 12px rgba(0, 123, 255, 0.7)) drop-shadow(0 0 24px rgba(0, 123, 255, 0.4));
        -webkit-filter: drop-shadow(0 0 12px rgba(0, 123, 255, 0.7)) drop-shadow(0 0 24px rgba(0, 123, 255, 0.4));
    }
    /* Alto del mapa en el modal */
    #map-picker { height: 60vh; }
</style>

<!-- Leaflet CSS solo para esta página -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

<div class="row">
    <div class="col-12 col-md-10 col-lg-8 mx-auto">
        <img src="/static/imgs/logo.png" class="el_logo" alt="Logo">
        <div class="card shadow-sm">
            <div class="card-body">
                <h1 class="h4 mb-3">DATOS PRINCIPALES</h1>

                <form id="form-principal" novalidate>
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label for="ancho" class="form-label">ANCHO (m)</label>
                            <input type="number" step="0.01" min="0" class="form-control" id="ancho"
                                placeholder="Ej: 50" required>
                            <div class="invalid-feedback">Ingresa un ancho válido.</div>
                        </div>
                        <div class="col-6">
                            <label for="alto" class="form-label">ALTO (m)</label>
                            <input type="number" step="0.01" min="0" class="form-control" id="alto" placeholder="Ej: 30"
                                required>
                            <div class="invalid-feedback">Ingresa un alto válido.</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="tipoPlanta" class="form-label">Tipo de planta</label>
                        <select id="tipoPlanta" class="form-select" required>
                            <option value="" selected disabled>Selecciona una opción</option>
                            <option value="tomate">Tomate</option>
                            <option value="maiz">Maiz</option>
                            <option value="lechuga">Lechuga</option>
                        </select>
                        <div class="invalid-feedback">Selecciona un tipo de planta.</div>
                    </div>

                    <div class="row g-2 align-items-end mb-2">
                        <div class="col-12">
                            <label class="form-label">Coordenadas</label>
                        </div>
                        <div class="col-6">
                            <input type="text" inputmode="decimal" class="form-control" id="lat" placeholder="Latitud"
                                required>
                            <div class="invalid-feedback">Latitud inválida.</div>
                        </div>
                        <div class="col-6">
                            <input type="text" inputmode="decimal" class="form-control" id="lng" placeholder="Longitud"
                                required>
                            <div class="invalid-feedback">Longitud inválida.</div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6 mx-0 pe-1">
                            <button type="button" id="btn-geolocate" class="btn btn-outline-success">Usar mi
                                ubicación</button>
                        </div>
                        <div class="col-6 mx-0 ps-1">
                            <button type="button" id="btn-pick-location" class="btn btn-outline-success">Usar otra
                                ubicación</button>
                        </div>

                    </div>
                    <button type="submit" class="btn btn-success w-100">Continuar</button>
                    <div id="status" class="small text-muted"></div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para seleccionar ubicación en el mapa -->
<div class="modal fade" id="modalMap" tabindex="-1" aria-labelledby="modalMapLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-sm-down modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalMapLabel">Selecciona la ubicación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <div id="map-picker"></div>
      </div>
      <div class="modal-footer d-flex w-100 justify-content-between">
        <div class="text-muted small" id="picked-preview">Haz clic en el mapa para elegir un punto.</div>
        <div>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" id="btn-confirm-location">Usar esta ubicación</button>
        </div>
      </div>
    </div>
  </div>
  </div>
{% endblock %}

{% block scripts %}
<!-- Leaflet JS solo para esta página -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
    (() => {
        const form = document.getElementById('form-principal');
        const statusEl = document.getElementById('status');
        const latEl = document.getElementById('lat');
        const lngEl = document.getElementById('lng');
        const pickBtn = document.getElementById('btn-pick-location');
        const confirmBtn = document.getElementById('btn-confirm-location');
        const previewEl = document.getElementById('picked-preview');
        const modalEl = document.getElementById('modalMap');
        let modalInstance = null;
        let map = null;
        let marker = null;
        let pickedLatLng = null;

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }
            const data = {
                ancho: document.getElementById('ancho').value,
                alto: document.getElementById('alto').value,
                tipoPlanta: document.getElementById('tipoPlanta').value,
                lat: latEl.value,
                lng: lngEl.value,
            };
            console.log('Datos principales', data);
            window.location.href = '/Principal';
        });

        document.getElementById('btn-geolocate').addEventListener('click', () => {
            if (!('geolocation' in navigator)) {
                statusEl.textContent = 'Geolocalización no soportada en este dispositivo.';
                return;
            }
            statusEl.textContent = 'Obteniendo ubicación…';
            navigator.geolocation.getCurrentPosition((pos) => {
                const { latitude, longitude } = pos.coords;
                latEl.value = latitude.toFixed(6);
                lngEl.value = longitude.toFixed(6);
                statusEl.textContent = 'Ubicación obtenida.';
            }, (err) => {
                statusEl.textContent = 'No se pudo obtener la ubicación: ' + err.message;
            }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
        });

        // Abrir modal y cargar mapa para elegir ubicación manualmente
        if (pickBtn) {
            pickBtn.addEventListener('click', () => {
                if (!modalInstance) {
                    modalInstance = new bootstrap.Modal(modalEl);
                }
                modalInstance.show();
                // Dar tiempo a que el modal se muestre antes de calcular tamaño del mapa
                setTimeout(() => {
                    if (!map) {
                        const startLat = parseFloat(latEl.value) || 18.7357; // RD por defecto, ajusta a tu región
                        const startLng = parseFloat(lngEl.value) || -70.1627;
                        map = L.map('map-picker').setView([startLat, startLng], 7);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            maxZoom: 19,
                            attribution: '&copy; OpenStreetMap'
                        }).addTo(map);
                        map.on('click', (e) => {
                            pickedLatLng = e.latlng;
                            if (!marker) {
                                marker = L.marker(e.latlng, { draggable: true }).addTo(map);
                                marker.on('dragend', () => {
                                    pickedLatLng = marker.getLatLng();
                                    previewEl.textContent = `Lat: ${pickedLatLng.lat.toFixed(6)}, Lng: ${pickedLatLng.lng.toFixed(6)}`;
                                });
                            } else {
                                marker.setLatLng(e.latlng);
                            }
                            previewEl.textContent = `Lat: ${pickedLatLng.lat.toFixed(6)}, Lng: ${pickedLatLng.lng.toFixed(6)}`;
                        });
                    } else {
                        map.invalidateSize();
                    }
                }, 150);
            });
        }

        if (confirmBtn) {
            confirmBtn.addEventListener('click', () => {
                if (pickedLatLng) {
                    latEl.value = pickedLatLng.lat.toFixed(6);
                    lngEl.value = pickedLatLng.lng.toFixed(6);
                }
                if (!modalInstance) {
                    modalInstance = new bootstrap.Modal(modalEl);
                }
                modalInstance.hide();
            });
        }
    })();
</script>
{% endblock %}